<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 8-Week Running & Strength Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Link to the external plan data file. This will be used when running locally. -->
    <script>
        document.write('<script src="plan.js?' + new Date().getTime() + '"><\/script>');
    </script>

    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #D1D5DB; /* gray-300 */
        }
        .carousel-container {
            overflow: hidden;
            position: relative;
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Bouncy transition */
        }
        .carousel-slide {
            min-width: 100%;
            box-sizing: border-box;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .carousel-slide.active {
            opacity: 1;
            transform: scale(1);
        }
        .details-panel {
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .day-header.active-day {
            background-color: #fbbf24; /* amber-400 */
            color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .day-header.active-day h4, .day-header.active-day p {
            color: #1f2937; /* gray-800 */
        }
        .day-header.current-day-highlight {
            box-shadow: 0 0 0 2px #fbbf24, 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* amber-400 border and existing shadow */
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        /* Modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        /* Tab styles */
        .tab-btn.active, .stretch-tab-btn.active {
            border-color: #fbbf24; /* amber-400 */
            color: #fbbf24;
        }
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8 md:mb-12 relative">
            <h1 id="plan-title" class="text-3xl md:text-5xl font-bold text-gray-100">Your 8-Week Training Plan</h1>
            <p id="plan-subtitle" class="text-lg md:text-xl text-gray-400 mt-2">To a Sub-25min 5k & Sub-60min 10k</p>
            <div class="mt-6 max-w-2xl mx-auto">
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="total-progress-bar" class="bg-green-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <p id="total-progress-text" class="text-sm text-gray-400 mt-1 text-right">Overall Progress: 0%</p>
            </div>
             <div class="absolute top-0 right-0">
                <button id="reset-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">Reset Progress</button>
            </div>
        </header>

        <main>
            <!-- Tabs for Plan and Progress -->
            <div class="mb-6 border-b border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-plan" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        Workout Plan
                    </button>
                    <button id="tab-progress" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 font-medium text-lg">
                        My Progress
                    </button>
                </nav>
            </div>

            <!-- Main Content Area -->
            <div id="tab-content-plan">
                <!-- Weekly Carousel Section -->
                <section id="carousel-section" class="mb-8 md:mb-12 bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="carousel-container">
                        <div id="carousel-track" class="carousel-track">
                            <!-- Carousel slides will be populated by JS -->
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <button id="prev-btn" aria-label="Previous Week" class="bg-amber-600 text-white font-bold p-3 rounded-full hover:bg-amber-700 transition-colors disabled:bg-gray-600 disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div id="carousel-dots" class="flex space-x-2">
                            <!-- Dots will be populated by JS -->
                        </div>
                        <button id="next-btn" aria-label="Next Week" class="bg-amber-600 text-white font-bold p-3 rounded-full hover:bg-amber-700 transition-colors disabled:bg-gray-600 disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </section>
            </div>

            <div id="tab-content-progress" class="hidden">
                 <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-amber-400 mb-4 text-center">Total Miles Per Week</h2>
                    <div class="relative h-96">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stretch Routine Section -->
            <section id="stretch-section" class="mt-8 md:mt-12 bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-amber-400 mb-4 text-center">Stretch Routines</h2>
                
                <!-- Stretch Tabs -->
                <div class="mb-4 border-b border-gray-700">
                    <nav class="-mb-px flex space-x-6 justify-center" aria-label="Stretch Tabs">
                        <button id="tab-warmup" class="stretch-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-base text-gray-400 hover:text-gray-200 hover:border-gray-500">
                            Warm-up
                        </button>
                        <button id="tab-cooldown" class="stretch-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-medium text-base text-gray-400 hover:text-gray-200 hover:border-gray-500">
                            Cool-down
                        </button>
                    </nav>
                </div>

                <!-- Stretch Content -->
                <div>
                    <div id="stretch-content-warmup" class="stretch-content">
                        <!-- Warm-up stretches will be populated by JS -->
                    </div>
                    <div id="stretch-content-cooldown" class="stretch-content hidden">
                        <!-- Cool-down stretches will be populated by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-8 transform scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-red-500 mb-4">Are you sure?</h2>
            <p class="text-gray-300 mb-8">This will permanently delete all your logged workouts and reset your progress. This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-reset-btn" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
                <button id="confirm-reset-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition-colors">Yes, Reset</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Fallback Data ---
            // This data is used if plan.js is not found. It's essential for previews and offline use.
            if (typeof window.trainingPlanData === 'undefined') {
                console.warn("plan.js not found. Using fallback data. This is expected in the preview environment.");
                window.trainingPlanData = {
                    id: "sub25_5k_sub60_10k_v2",
                    title: "Your 8-Week Training Plan",
                    subtitle: "To a Sub-25min 5k & Sub-60min 10k",
                    daysOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    workoutTypes: ['Interval Run', 'Upper Push', 'Tempo Run', 'Upper Pull', 'Legs & Core', 'Long Run', 'Rest'],
                    paceGuide: {
                        labels: ['Easy Run', 'Tempo Run', 'Interval (400m)', 'Long Run'],
                        displayPace: ['11:00-12:00', '9:30-10:00', '2:00-2:05/lap', '11:30-12:30']
                    },
                    strengthWorkouts: {
                        'Legs & Core': [
                            { name: 'Goblet Squats', desc: 'Hold a weight at your chest. Squat down keeping your chest up and back straight.', sets: '3-4', reps: '8-12' },
                            { name: 'Romanian Deadlifts', desc: 'Hold a barbell or dumbbells. Hinge at your hips, keeping your back straight and legs almost straight.', sets: '3-4', reps: '8-12' },
                            { name: 'Walking Lunges', desc: 'Step forward into a lunge, then push off and step into the next lunge with the other leg.', sets: '3', reps: '10-12/leg' },
                            { name: 'Plank', desc: 'Hold a push-up position with a flat back and engaged core.', sets: '3', reps: '45-90s' },
                            { name: 'Hanging Knee Raises', desc: 'Hang from a bar and raise your knees towards your chest.', sets: '3', reps: '10-15' },
                            { name: 'Calf Raises', desc: 'Stand on a flat surface and raise your heels up, then lower them back down.', sets: '3', reps: '15-20' },
                        ],
                        'Upper Push': [
                            { name: 'Push-ups', desc: 'Perform standard push-ups, or modified on your knees if needed. Focus on chest and triceps.', sets: '3-4', reps: 'To failure' },
                            { name: 'Dumbbell Bench Press', desc: 'Lie on a bench and press dumbbells up from your chest.', sets: '3-4', reps: '8-12' },
                            { name: 'Overhead Press (Dumbbell)', desc: 'Sit or stand, pressing dumbbells from your shoulders to overhead.', sets: '3-4', reps: '8-12' },
                            { name: 'Lateral Raises', desc: 'Stand with dumbbells at your sides. Raise them out to the side to shoulder height.', sets: '3', reps: '12-15' },
                            { name: 'Tricep Dips (on bench)', desc: 'Place hands on a bench behind you, lower your body down and push back up.', sets: '3', reps: '10-15' },
                        ],
                        'Upper Pull': [
                            { name: 'Pull-ups / Assisted Pull-ups', desc: 'Use a wide grip to pull your chin over the bar. Use a band for assistance if needed.', sets: '3-4', reps: 'To failure' },
                            { name: 'Bent Over Rows (Dumbbell)', desc: 'Hinge at the waist with a flat back. Pull dumbbells up towards your lower chest.', sets: '3-4', reps: '8-12' },
                            { name: 'Face Pulls', desc: 'Use a cable machine or resistance band. Pull the rope towards your face, squeezing your rear delts.', sets: '3', reps: '12-15' },
                            { name: 'Bicep Curls (Dumbbell)', desc: 'Stand and curl dumbbells from your thighs up to your shoulders.', sets: '3', reps: '10-15' },
                            { name: 'Reverse Flys', desc: 'Hinge forward with a flat back, arms extended. Open your arms out to the side, squeezing your shoulder blades.', sets: '3', reps: '12-15' },
                        ]
                    },
                    weeklyPlan: [
                        { intervalReps: 6, tempoMins: 20, longRunDist: 3.5 }, { intervalReps: 7, tempoMins: 25, longRunDist: 4.0 },
                        { intervalReps: 8, tempoMins: 30, longRunDist: 4.5 }, { intervalReps: 9, tempoMins: 35, longRunDist: 5.0 },
                        { intervalReps: 10, tempoMins: 40, longRunDist: 5.5 }, { intervalReps: 11, tempoMins: 40, longRunDist: 6.0 },
                        { intervalReps: 12, tempoMins: 30, longRunDist: 6.5 }, { intervalReps: 8, tempoMins: 20, longRunDist: 7.0 },
                    ],
                    warmupStretches: [
                        { name: "Jumping Jacks", desc: "Start with feet together and arms at your sides, then jump while spreading your legs and bringing your arms overhead. 30 seconds." },
                        { name: "High Knees", desc: "Run in place or move forward, bringing your knees up towards your chest. Keep your core engaged. Do for 30 seconds." },
                        { name: "Leg Swings (Forward & Sideways)", desc: "Hold onto something for balance and swing each leg forward/backward and side-to-side. 10-12 swings each direction." },
                        { name: "Torso Twists", desc: "Stand with feet shoulder-width apart and twist your upper body from side to side. 10-12 twists each side." },
                        { name: "Arm Circles", desc: "Extend your arms to the side and make small circles, gradually getting bigger. 10-15 circles forward and backward." }
                    ],
                    cooldownStretches: [
                        { name: "Standing Quad Stretch", desc: "Stand on one leg, pull the other foot towards your glute, feeling a stretch in the front of your thigh. Hold for 30 seconds per leg." },
                        { name: "Standing Hamstring Stretch", desc: "Extend one leg forward with the heel on the ground. Hinge at your hips and lean forward until you feel a stretch. Hold for 30 seconds per leg." },
                        { name: "Calf Stretch", desc: "Stand facing a wall with your hands on it. Step one foot back and press the heel to the floor. Hold for 30 seconds per leg." },
                        { name: "Glute Stretch (Pigeon Pose)", desc: "From a plank position, bring one knee forward towards the opposite hand, lowering your hips. Hold for 30 seconds per side." },
                        { name: "Triceps Stretch", desc: "Reach one arm overhead, bend the elbow, and gently pull the elbow with the opposite hand. Hold for 30 seconds per arm." },
                        { name: "Chest Stretch", desc: "Clasp your hands behind your back and gently pull them down and away from your body. Hold for 30 seconds." }
                    ]
                };
            }

            const App = {
                windowWidth: 0,
                currentWeekIndex: 0,
                activeChart: null,
                workoutLogs: {},
                planData: window.trainingPlanData,

                getDOMElements() {
                    this.dom = {
                        planTitle: document.getElementById('plan-title'),
                        planSubtitle: document.getElementById('plan-subtitle'),
                        carouselTrack: document.getElementById('carousel-track'),
                        dotsContainer: document.getElementById('carousel-dots'),
                        prevBtn: document.getElementById('prev-btn'),
                        nextBtn: document.getElementById('next-btn'),
                        totalProgressBar: document.getElementById('total-progress-bar'),
                        totalProgressText: document.getElementById('total-progress-text'),
                        tabPlan: document.getElementById('tab-plan'),
                        tabProgress: document.getElementById('tab-progress'),
                        contentPlan: document.getElementById('tab-content-plan'),
                        contentProgress: document.getElementById('tab-content-progress'),
                        tabWarmup: document.getElementById('tab-warmup'),
                        tabCooldown: document.getElementById('tab-cooldown'),
                        contentWarmup: document.getElementById('stretch-content-warmup'),
                        contentCooldown: document.getElementById('stretch-content-cooldown'),
                        resetModal: document.getElementById('reset-modal'),
                        resetBtn: document.getElementById('reset-btn'),
                        cancelResetBtn: document.getElementById('cancel-reset-btn'),
                        confirmResetBtn: document.getElementById('confirm-reset-btn'),
                    };
                },

                init() {
                    this.getDOMElements();
                    this.windowWidth = window.innerWidth;
                    this.todayIndex = (new Date().getDay() + 6) % 7;
                    this.loadLogsFromStorage();
                    this.addEventListeners();
                    this.updateHeaders();
                    this.render();
                },

                updateHeaders() {
                    this.dom.planTitle.textContent = this.planData.title;
                    this.dom.planSubtitle.textContent = this.planData.subtitle;
                },
                
                loadLogsFromStorage() {
                    const key = `workoutLogs_${this.planData.id}`;
                    this.workoutLogs = JSON.parse(localStorage.getItem(key)) || {};
                },

                saveLogsToStorage() {
                    const key = `workoutLogs_${this.planData.id}`;
                    localStorage.setItem(key, JSON.stringify(this.workoutLogs));
                },

                addEventListeners() {
                    this.dom.prevBtn.addEventListener('click', () => this.changeWeek(-1));
                    this.dom.nextBtn.addEventListener('click', () => this.changeWeek(1));
                    this.dom.dotsContainer.addEventListener('click', (e) => {
                        if(e.target.tagName === 'BUTTON') {
                            this.currentWeekIndex = parseInt(e.target.dataset.index);
                            this.updateCarousel();
                        }
                    });
                    this.dom.carouselTrack.addEventListener('click', (e) => this.handleCarouselClick(e));
                    window.addEventListener('resize', () => this.handleResize());
                    this.dom.tabPlan.addEventListener('click', () => this.switchTab('plan'));
                    this.dom.tabProgress.addEventListener('click', () => this.switchTab('progress'));
                    this.dom.tabWarmup.addEventListener('click', () => this.switchStretchTab('warmup'));
                    this.dom.tabCooldown.addEventListener('click', () => this.switchStretchTab('cooldown'));
                    this.dom.resetBtn.addEventListener('click', () => this.toggleModal('reset-modal', true));
                    this.dom.cancelResetBtn.addEventListener('click', () => this.toggleModal('reset-modal', false));
                    this.dom.confirmResetBtn.addEventListener('click', () => this.resetProgress());
                },
                
                handleResize() {
                    if (window.innerWidth === this.windowWidth) {
                        return; // Exit if width hasn't changed
                    }
                    this.windowWidth = window.innerWidth;

                    const openDetails = this.dom.carouselTrack.querySelector('.details-panel.open');
                    if (openDetails) {
                        openDetails.classList.remove('open');
                        openDetails.style.maxHeight = '0px';
                        const activeHeader = this.dom.carouselTrack.querySelector('.day-header.active-day');
                        if(activeHeader) activeHeader.classList.remove('active-day');
                    }
                    this.updateCarousel();
                },

                render() {
                    this.renderCarousel();
                    this.updateCarousel();
                    this.updateProgress();
                    this.renderProgressChart();
                    this.renderStretchRoutines();
                },
                
                renderStretchRoutines() {
                    const createStretchList = (stretches) => `<ul class="divide-y divide-gray-700">${stretches.map(s => `<li class="py-3"><strong class="block text-base font-medium text-gray-100">${s.name}</strong><p class="text-sm text-gray-400">${s.desc}</p></li>`).join('')}</ul>`;
                    this.dom.contentWarmup.innerHTML = createStretchList(this.planData.warmupStretches);
                    this.dom.contentCooldown.innerHTML = createStretchList(this.planData.cooldownStretches);
                },

                renderCarousel() {
                    this.dom.carouselTrack.innerHTML = '';
                    this.dom.dotsContainer.innerHTML = '';
                    this.planData.weeklyPlan.forEach((weekData, index) => {
                        const slide = document.createElement('div');
                        slide.className = 'carousel-slide p-2';
                        slide.dataset.weekIndex = index;
                        let completedInWeek = 0;
                        for (let i = 0; i < this.planData.daysOfWeek.length; i++) {
                            if (this.workoutLogs[`${index}-${i}`] && this.workoutLogs[`${index}-${i}`].completed) completedInWeek++;
                        }
                        const weeklyPercentage = (completedInWeek / this.planData.daysOfWeek.length) * 100;
                        slide.innerHTML = `
                            <h2 class="text-2xl font-bold text-amber-400 mb-2 text-center">Week ${index + 1}</h2>
                            <div class="w-full bg-gray-600 rounded-full h-2 mb-4"><div class="bg-green-500 h-2 rounded-full progress-bar" style="width: ${weeklyPercentage}%"></div></div>
                            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-amber-200">Intervals</p><p class="font-bold text-xl text-gray-100">${weekData.intervalReps} x 400m</p></div>
                                <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-amber-200">Tempo</p><p class="font-bold text-xl text-gray-100">${weekData.tempoMins} mins</p></div>
                                <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-amber-200">Long Run</p><p class="font-bold text-xl text-gray-100">${weekData.longRunDist} miles</p></div>
                                <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-amber-200">Strength</p><p class="font-bold text-xl text-gray-100">3 sessions</p></div>
                            </div>
                            <div class="space-y-2 md:hidden">${this.planData.daysOfWeek.map((day, dayIndex) => this.generateDayHTML(index, dayIndex, 'mobile')).join('')}</div>
                            <div class="hidden md:grid md:grid-cols-7 md:gap-2">${this.planData.daysOfWeek.map((day, dayIndex) => this.generateDayHTML(index, dayIndex, 'desktop')).join('')}</div>
                            <div id="desktop-details-week-${index}" class="details-panel hidden md:block mt-4"></div>`;
                        this.dom.carouselTrack.appendChild(slide);
                        const dot = document.createElement('button');
                        dot.className = 'w-3 h-3 rounded-full transition-colors';
                        dot.dataset.index = index;
                        this.dom.dotsContainer.appendChild(dot);
                    });
                },
                
                generateDayHTML(weekIndex, dayIndex, viewType) {
                    const workoutType = this.planData.workoutTypes[dayIndex];
                    const dayName = this.planData.daysOfWeek[dayIndex];
                    const isRest = workoutType === 'Rest';
                    const logKey = `${weekIndex}-${dayIndex}`;
                    const isCompleted = this.workoutLogs[logKey] && this.workoutLogs[logKey].completed;
                    let bgColor = isRest ? 'bg-gray-700/80' : 'bg-gray-700/50';
                    let textColor = isRest ? 'text-gray-400' : 'text-amber-400';
                    let checkmark = '';
                    if (isCompleted) {
                        bgColor = 'bg-green-600';
                        textColor = 'text-white';
                        checkmark = `<div class="absolute top-1 right-1 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>`;
                    }
                    const isToday = dayIndex === this.todayIndex;
                    const todayClass = isToday ? 'current-day-highlight' : '';
                    const headerHTML = `<div class="day-header p-3 rounded-lg shadow-sm cursor-pointer transition-all duration-300 hover:bg-gray-600/50 ${bgColor} ${todayClass} flex flex-col justify-center text-center min-h-[100px] gap-1 relative" data-day-index="${dayIndex}" data-week-index="${weekIndex}"><p class="font-bold ${isCompleted ? 'text-gray-200' : 'text-gray-400'} text-xs uppercase">${dayName}</p><h4 class="text-lg font-semibold ${textColor}">${workoutType}</h4>${checkmark}</div>`;
                    return viewType === 'mobile' ? `<div class="day-wrapper-mobile rounded-lg ${isCompleted ? 'bg-green-600' : 'bg-gray-700/50'}">${headerHTML}<div class="details-panel mobile-details"></div></div>` : headerHTML;
                },

                updateCarousel() {
                    const slide = this.dom.carouselTrack.querySelector('.carousel-slide');
                    if (!slide) return;
                    const slideWidth = slide.clientWidth;
                    this.dom.carouselTrack.style.transform = `translateX(-${this.currentWeekIndex * slideWidth}px)`;
                    this.dom.carouselTrack.querySelectorAll('.carousel-slide').forEach((s, i) => s.classList.toggle('active', i === this.currentWeekIndex));
                    this.dom.dotsContainer.querySelectorAll('button').forEach((dot, i) => dot.className = `w-3 h-3 rounded-full transition-colors ${i === this.currentWeekIndex ? 'bg-amber-400' : 'bg-gray-600'}`);
                    this.dom.prevBtn.disabled = this.currentWeekIndex === 0;
                    this.dom.nextBtn.disabled = this.currentWeekIndex === this.planData.weeklyPlan.length - 1;
                },
                
                updateProgress() {
                    const totalWorkouts = this.planData.weeklyPlan.length * this.planData.daysOfWeek.length;
                    const completedCount = Object.values(this.workoutLogs).filter(log => log.completed).length;
                    const totalPercentage = totalWorkouts > 0 ? (completedCount / totalWorkouts) * 100 : 0;
                    this.dom.totalProgressBar.style.width = `${totalPercentage}%`;
                    this.dom.totalProgressText.textContent = `Overall Progress: ${Math.round(totalPercentage)}%`;
                },

                renderProgressChart() {
                    if (!this.dom.contentProgress.offsetParent) return;
                    const ctx = document.getElementById('progress-chart').getContext('2d');
                    const weeklyTotals = Array(this.planData.weeklyPlan.length).fill(0);
                    Object.entries(this.workoutLogs).forEach(([key, log]) => {
                        if (log.completed && log.distance) {
                            const [weekIndexStr, dayIndexStr] = key.split('-');
                            const weekIndex = parseInt(weekIndexStr, 10);
                            const dayIndex = parseInt(dayIndexStr, 10);
                            if (!isNaN(weekIndex) && weekIndex < weeklyTotals.length && this.planData.workoutTypes[dayIndex].includes('Run')) {
                                weeklyTotals[weekIndex] += parseFloat(log.distance) || 0;
                            }
                        }
                    });
                    const labels = this.planData.weeklyPlan.map((_, index) => `Week ${index + 1}`);
                    if (this.activeChart) this.activeChart.destroy();
                    this.activeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Miles Ran',
                                data: weeklyTotals,
                                backgroundColor: 'rgba(251, 191, 36, 0.6)',
                                borderColor: '#fbbf24',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' }, title: { display: true, text: 'Total Miles Ran', color: '#d1d5db' }},
                                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                changeWeek(direction) {
                    const newIndex = this.currentWeekIndex + direction;
                    if (newIndex >= 0 && newIndex < this.planData.weeklyPlan.length) {
                        this.currentWeekIndex = newIndex;
                        this.updateCarousel();
                    }
                },

                switchTab(tabName) {
                    this.dom.contentPlan.classList.toggle('hidden', tabName !== 'plan');
                    this.dom.contentProgress.classList.toggle('hidden', tabName !== 'progress');
                    this.dom.tabPlan.classList.toggle('active', tabName === 'plan');
                    this.dom.tabProgress.classList.toggle('active', tabName === 'progress');
                    if (tabName === 'progress') this.renderProgressChart();
                },
                
                switchStretchTab(tabName) {
                    this.dom.contentWarmup.classList.toggle('hidden', tabName !== 'warmup');
                    this.dom.contentCooldown.classList.toggle('hidden', tabName !== 'cooldown');
                    this.dom.tabWarmup.classList.toggle('active', tabName === 'warmup');
                    this.dom.tabCooldown.classList.toggle('active', tabName === 'cooldown');
                },

                handleCarouselClick(e) {
                    const header = e.target.closest('.day-header');
                    if (header) this.toggleWorkoutDetails(header);
                    if (e.target.classList.contains('save-log-btn')) this.saveLog(e.target.dataset.logKey);
                },

                toggleWorkoutDetails(header) {
                    const weekIndex = parseInt(header.dataset.weekIndex);
                    const dayIndex = parseInt(header.dataset.dayIndex);
                    const slide = header.closest('.carousel-slide');
                    const isMobile = window.innerWidth < 768;
                    let detailsContainer = isMobile ? header.nextElementSibling : slide.querySelector(`#desktop-details-week-${weekIndex}`);
                    const wasOpen = detailsContainer.classList.contains('open') && header.classList.contains('active-day');
                    slide.querySelectorAll('.details-panel.open').forEach(p => { p.classList.remove('open'); p.style.maxHeight = '0px'; });
                    slide.querySelectorAll('.day-header.active-day').forEach(h => h.classList.remove('active-day'));
                    if (wasOpen) return;
                    header.classList.add('active-day');
                    const content = this.generateWorkoutDetailContent(dayIndex, weekIndex);
                    detailsContainer.innerHTML = `<div class="p-4 sm:p-6 bg-gray-700 rounded-lg">${content}</div>`;
                    detailsContainer.classList.add('open');
                    requestAnimationFrame(() => {
                        detailsContainer.style.maxHeight = detailsContainer.scrollHeight + 'px';
                    });
                },

                generateWorkoutDetailContent(dayIndex, weekIndex) {
                    const workoutType = this.planData.workoutTypes[dayIndex];
                    const weekData = this.planData.weeklyPlan[weekIndex];
                    const logKey = `${weekIndex}-${dayIndex}`;
                    const log = this.workoutLogs[logKey] || {};
                    let content = '', logInputs = '';
                    
                    if (workoutType === 'Interval Run') {
                        content = `<div class="space-y-3"><div><strong class="text-gray-200">Warm-up:</strong> 10-15 minutes of easy jogging.</div><div><strong class="text-gray-200">Workout:</strong> ${weekData.intervalReps} x 400 meters at goal 5k pace.</div><div><strong class="text-gray-200">Target Pace:</strong> ${this.planData.paceGuide.displayPace[2]}.</div><div><strong class="text-gray-200">Recovery:</strong> 400 meters of slow jogging or walking between each interval.</div><div><strong class="text-gray-200">Cool-down:</strong> 10-15 minutes of easy jogging.</div></div>`;
                    } else if (workoutType === 'Tempo Run') {
                        content = `<div class="space-y-3"><div><strong class="text-gray-200">Warm-up:</strong> 10 minutes of easy jogging.</div><div><strong class="text-gray-200">Workout:</strong> Run for ${weekData.tempoMins} minutes at a tempo pace.</div><div><strong class="text-gray-200">Target Pace:</strong> ${this.planData.paceGuide.displayPace[1]} min/mile. Should feel "comfortably hard".</div><div><strong class="text-gray-200">Cool-down:</strong> 10 minutes of easy jogging.</div></div>`;
                    } else if (workoutType === 'Long Run') {
                        content = `<div class="space-y-3"><div><strong class="text-gray-200">Workout:</strong> Run for ${weekData.longRunDist} miles.</div><div><strong class="text-gray-200">Target Pace:</strong> ${this.planData.paceGuide.displayPace[0]} or ${this.planData.paceGuide.displayPace[3]} min/mile. Keep it easy and conversational.</div><div><strong class="text-gray-200">Purpose:</strong> Build endurance. The goal is to cover the distance, not to run it fast.</div></div>`;
                    } else if (['Legs & Core', 'Upper Push', 'Upper Pull'].includes(workoutType)) {
                        const exercises = this.planData.strengthWorkouts[workoutType];
                        content = `<ul class="divide-y divide-gray-600">${exercises.map(ex => `<li class="flex justify-between items-center py-4"><div class="flex-grow pr-4"><strong class="block text-base font-medium text-gray-100">${ex.name}</strong><p class="text-sm text-gray-400">${ex.desc}</p></div><div class="text-right flex-shrink-0 w-24"><p class="text-base font-semibold text-amber-400">${ex.sets} sets</p><p class="text-sm text-gray-400">${ex.reps} reps</p></div></li>`).join('')}</ul>`;
                    } else {
                        content = `<p>Rest is crucial for recovery and muscle repair. You can do some light activity like walking or stretching, but avoid strenuous exercise.</p>`;
                    }

                    if (workoutType.includes('Run')) {
                        logInputs = `<div class="grid grid-cols-2 gap-4"><div><label for="log-dist-${logKey}" class="block text-sm font-medium text-gray-300">Distance (mi)</label><input type="number" step="0.1" id="log-dist-${logKey}" value="${log.distance || ''}" class="mt-1 block w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm p-2"></div><div><label for="log-time-${logKey}" class="block text-sm font-medium text-gray-300">Time (mm:ss)</label><input type="text" id="log-time-${logKey}" value="${log.time || ''}" class="mt-1 block w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm p-2"></div></div>`;
                    }

                    return `${content}${workoutType !== 'Rest' ? `<div class="log-section mt-6 pt-6 border-t border-gray-600"><h5 class="text-lg font-bold text-gray-100 mb-4">Log Your Workout</h5><div class="space-y-4"><div class="flex items-center"><input id="log-completed-${logKey}" type="checkbox" ${log.completed ? 'checked' : ''} class="h-5 w-5 rounded border-gray-500 text-amber-600 focus:ring-amber-500"><label for="log-completed-${logKey}" class="ml-3 block text-sm font-medium text-gray-200">Mark as Complete</label></div>${logInputs}<div><label for="log-notes-${logKey}" class="block text-sm font-medium text-gray-300">Notes</label><textarea id="log-notes-${logKey}" rows="3" class="mt-1 block w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm p-2">${log.notes || ''}</textarea></div><div class="flex justify-end items-center"><span id="save-confirm-${logKey}" class="text-green-400 text-sm mr-4 opacity-0 transition-opacity">Saved!</span><button class="save-log-btn bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors" data-log-key="${logKey}">Save Log</button></div></div></div>` : ''}`;
                },

                saveLog(logKey) {
                    const log = this.workoutLogs[logKey] || {};
                    log.completed = document.getElementById(`log-completed-${logKey}`).checked;
                    log.notes = document.getElementById(`log-notes-${logKey}`).value;
                    const distInput = document.getElementById(`log-dist-${logKey}`);
                    if (distInput) log.distance = distInput.value;
                    const timeInput = document.getElementById(`log-time-${logKey}`);
                    if (timeInput) log.time = timeInput.value;
                    this.workoutLogs[logKey] = log;
                    this.saveLogsToStorage();
                    const saveConfirm = document.getElementById(`save-confirm-${logKey}`);
                    if(saveConfirm) {
                        saveConfirm.classList.remove('opacity-0');
                        setTimeout(() => saveConfirm.classList.add('opacity-0'), 2000);
                    }
                    this.render();
                },

                resetProgress() {
                    this.workoutLogs = {};
                    this.saveLogsToStorage();
                    this.toggleModal('reset-modal', false);
                    this.render();
                },

                toggleModal(modalId, show) {
                    const modal = document.getElementById(modalId);
                    const content = modal.querySelector('.modal-content');
                    if (show) {
                        modal.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            modal.classList.remove('opacity-0');
                            content.classList.remove('scale-95', 'opacity-0');
                        });
                    } else {
                        modal.classList.add('opacity-0');
                        content.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => modal.classList.add('hidden'), 300);
                    }
                }
            };

            App.init();
        });
    </script>
</body>
</html>
